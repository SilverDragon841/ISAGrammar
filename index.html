<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ISAGrammar — Friendly Grammar Checker</title>
  <meta name="description" content="A fast grammar checker using LanguageTool. Animated 20-theme system, circular accuracy meter, one-click fixes." />

  <!-- Tailwind CDN -->
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    /* =====================
       THEME SYSTEM (20 themes)
       Each theme sets surface colors + gradient stops for animated background
    ===================== */
    :root {
      --bg: #ffffff;         /* page background */
      --text: #1f2937;       /* default text */
      --card: #ffffffcc;     /* card surface */
      --border: #e5e7eb;     /* card border */
      --primary: #8b5cf6;    /* buttons / highlights */
      --accent: #f97316;     /* accents */
      --g1:#a78bfa; --g2:#f472b6; --g3:#f59e0b; /* animated bg gradient stops */
    }

    /* Light / Dark */
    [data-theme="light"]   { --bg:#ffffff; --text:#0f172a; --card:#ffffffcc; --border:#e5e7eb; --primary:#8b5cf6; --accent:#f97316; --g1:#93c5fd; --g2:#a78bfa; --g3:#fda4af; }
    [data-theme="dark"]    { --bg:#0b1023; --text:#e5e7eb; --card:#0f172ad9; --border:#1f2937; --primary:#6366f1; --accent:#f59e0b; --g1:#1f2937; --g2:#4f46e5; --g3:#0ea5e9; }

    /* Extra palettes */
    [data-theme="sunset"]  { --bg:#1e1b4b; --text:#fdf4ff; --card:#312e81cc; --border:#4338ca; --primary:#ec4899; --accent:#f43f5e; --g1:#f43f5e; --g2:#f97316; --g3:#eab308; }
    [data-theme="forest"]  { --bg:#052e16; --text:#dcfce7; --card:#064e3bcc; --border:#065f46; --primary:#22c55e; --accent:#84cc16; --g1:#14532d; --g2:#22c55e; --g3:#a3e635; }
    [data-theme="ocean"]   { --bg:#03131f; --text:#e0f2fe; --card:#0b2a42cc; --border:#0ea5e9; --primary:#0ea5e9; --accent:#38bdf8; --g1:#0ea5e9; --g2:#22d3ee; --g3:#60a5fa; }
    [data-theme="rose"]    { --bg:#3b082b; --text:#ffe4e6; --card:#5b0a40cc; --border:#be123c; --primary:#f43f5e; --accent:#fb7185; --g1:#f472b6; --g2:#fb7185; --g3:#fecdd3; }
    [data-theme="matrix"]  { --bg:#000000; --text:#d1fae5; --card:#06110acc; --border:#064e3b; --primary:#22c55e; --accent:#4ade80; --g1:#052e16; --g2:#16a34a; --g3:#22c55e; }
    [data-theme="cyberpunk"]{--bg:#0f0a1a; --text:#f9a8d4; --card:#110f2bcc; --border:#4c1d95; --primary:#e879f9; --accent:#22d3ee; --g1:#7c3aed; --g2:#22d3ee; --g3:#e879f9; }
    [data-theme="candy"]   { --bg:#fef3c7; --text:#7c2d12; --card:#fff7edcc; --border:#fed7aa; --primary:#f472b6; --accent:#f59e0b; --g1:#fbcfe8; --g2:#fde68a; --g3:#fca5a5; }
    [data-theme="space"]   { --bg:#070a12; --text:#e2e8f0; --card:#0b1221cc; --border:#1f2937; --primary:#3b82f6; --accent:#9333ea; --g1:#1e3a8a; --g2:#3730a3; --g3:#7c3aed; }
    [data-theme="lava"]    { --bg:#1c1917; --text:#fff7ed; --card:#2b211fcc; --border:#7c2d12; --primary:#ef4444; --accent:#f97316; --g1:#7f1d1d; --g2:#ef4444; --g3:#f59e0b; }
    [data-theme="desert"]  { --bg:#fdf6e7; --text:#78350f; --card:#fff7edcc; --border:#fcd34d; --primary:#f59e0b; --accent:#d97706; --g1:#fde68a; --g2:#fbbf24; --g3:#f59e0b; }
    [data-theme="aurora"]  { --bg:#07121e; --text:#e0f2f1; --card:#0b2234cc; --border:#0d9488; --primary:#14b8a6; --accent:#6366f1; --g1:#14b8a6; --g2:#22d3ee; --g3:#6366f1; }
    [data-theme="galaxy"]  { --bg:#0f1020; --text:#ede9fe; --card:#1b1c3bcc; --border:#6d28d9; --primary:#8b5cf6; --accent:#f43f5e; --g1:#4c1d95; --g2:#8b5cf6; --g3:#f43f5e; }
    [data-theme="neon"]    { --bg:#0b0b0b; --text:#e0f2fe; --card:#121212cc; --border:#22d3ee; --primary:#22d3ee; --accent:#f472b6; --g1:#06b6d4; --g2:#22d3ee; --g3:#f472b6; }
    [data-theme="midnight"]{ --bg:#0a0f1f; --text:#cbd5e1; --card:#0e182ecc; --border:#334155; --primary:#334155; --accent:#475569; --g1:#0ea5e9; --g2:#334155; --g3:#7dd3fc; }
    [data-theme="vintage"] { --bg:#faf7f2; --text:#4b341c; --card:#fff9f0cc; --border:#e7d5b3; --primary:#b7791f; --accent:#92400e; --g1:#fde68a; --g2:#d4a373; --g3:#b08968; }
    [data-theme="coffee"]  { --bg:#211a17; --text:#f5f5f4; --card:#2a221fcc; --border:#6b7280; --primary:#6d28d9; --accent:#d97706; --g1:#78350f; --g2:#a16207; --g3:#6d28d9; }
    [data-theme="ice"]     { --bg:#e0f2fe; --text:#0c4a6e; --card:#f0f9ffcc; --border:#bae6fd; --primary:#38bdf8; --accent:#06b6d4; --g1:#93c5fd; --g2:#38bdf8; --g3:#a5f3fc; }
    [data-theme="sakura"]  { --bg:#fff1f2; --text:#831843; --card:#ffe4e6cc; --border:#fecdd3; --primary:#f472b6; --accent:#fda4af; --g1:#f9a8d4; --g2:#fda4af; --g3:#fecdd3; }

    /* =====================
       Animated Background Layer
    ===================== */
    #animated-bg {
      position: fixed; inset: 0; z-index: 0; pointer-events:none;
      background: radial-gradient(40% 40% at 20% 20%, var(--g1) 0%, transparent 60%),
                  radial-gradient(35% 35% at 80% 30%, var(--g2) 0%, transparent 60%),
                  radial-gradient(45% 45% at 50% 80%, var(--g3) 0%, transparent 60%);
      filter: blur(60px) saturate(140%);
      opacity: 0.45;
      animation: bgFloat 18s ease-in-out infinite alternate;
    }
    @keyframes bgFloat {
      0%   { transform: translate3d(0,0,0) scale(1); }
      50%  { transform: translate3d(-2%,1%,0) scale(1.05); }
      100% { transform: translate3d(2%,-1%,0) scale(1); }
    }

    /* Page surfaces & transitions */
    body { background: var(--bg); color: var(--text); transition: background .5s, color .5s; }
    .surface { background: var(--card); border-color: var(--border); }
    .accent-border { border-color: var(--accent); }
    .primary-bg { background: var(--primary); }
    .accent-bg { background: var(--accent); }
    .theme-transition * { transition: all .35s ease !important; }

    /* Underline style for issues in preview */
    .issue-underline { text-decoration: underline wavy; text-underline-offset: 3px; }

    /* Smooth shadows */
    .shadow-smooth { box-shadow: 0 10px 30px rgba(0,0,0,.15); }

    /* Buttons glow on hover */
    .btn-glow:hover { box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary) 30%, transparent); }

    /* Hide number spinners for consistency (not used but handy) */
    input::-webkit-outer-spin-button, input::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  </style>
</head>
<body class="min-h-screen">

  <!-- Animated background layer -->
  <div id="animated-bg"></div>

  <!-- App container -->
  <div class="relative z-10">
    <!-- Header -->
    <header class="sticky top-0 z-30 backdrop-blur-lg surface border-b px-4 py-3">
      <div class="max-w-6xl mx-auto flex items-center gap-3">
        <div class="w-10 h-10 rounded-2xl primary-bg grid place-content-center text-white font-black shadow-smooth">
          ISA
        </div>
        <div class="mr-auto">
          <h1 class="text-lg font-semibold leading-tight">ISAGrammar</h1>
          <p class="text-xs opacity-70 -mt-0.5">Click-to-fix grammar</p>
        </div>

        <label class="sr-only" for="language">Language</label>
        <select id="language" class="rounded-xl border focus:outline-none px-3 py-2 text-sm surface">
          <option value="en-US">English (US)</option>
          <option value="en-GB">English (UK)</option>
          <option value="en">English (General)</option>
          <option value="es">Español</option>
          <option value="fr">Français</option>
          <option value="de">Deutsch</option>
          <option value="pt">Português</option>
          <option value="it">Italiano</option>
        </select>

        <select id="themeSelect" class="ml-3 rounded-xl border focus:outline-none px-3 py-2 text-sm surface">
          <option value="light">Light</option>
          <option value="dark">Dark</option>
          <option value="sunset">Sunset</option>
          <option value="forest">Forest</option>
          <option value="ocean">Ocean</option>
          <option value="rose">Rose</option>
          <option value="matrix">Matrix</option>
          <option value="cyberpunk">Cyberpunk</option>
          <option value="candy">Candy</option>
          <option value="space">Space</option>
          <option value="lava">Lava</option>
          <option value="desert">Desert</option>
          <option value="aurora">Aurora</option>
          <option value="galaxy">Galaxy</option>
          <option value="neon">Neon</option>
          <option value="midnight">Midnight</option>
          <option value="vintage">Vintage</option>
          <option value="coffee">Coffee</option>
          <option value="ice">Ice</option>
          <option value="sakura">Sakura</option>
        </select>
      </div>
    </header>

    <!-- Main -->
    <main class="max-w-6xl mx-auto px-4 py-6 grid grid-cols-1 lg:grid-cols-2 gap-6">
      <!-- Editor Card -->
      <section class="surface rounded-2xl border p-4 lg:p-6 shadow-smooth">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-semibold">Write or paste your text</h2>
          <div class="flex items-center gap-2">
            <button id="pasteBtn" class="text-xs px-3 py-1.5 rounded-lg border surface btn-glow">Paste</button>
            <button id="clearBtn" class="text-xs px-3 py-1.5 rounded-lg border surface btn-glow">Clear</button>
            <button id="checkBtn" class="text-xs font-semibold px-3 py-1.5 rounded-lg primary-bg text-white btn-glow">Check Grammar</button>
          </div>
        </div>

        <div class="relative">
          <textarea id="inputText" class="w-full h-64 lg:h-80 resize-y rounded-xl border p-4 leading-7 text-[15px] surface focus:outline-none focus:ring-2" placeholder="Type something here… For example: This sentences have an error."></textarea>
          <div class="mt-3 flex items-center gap-3 text-xs opacity-70">
            <span id="charCount">0 characters</span>
            <span>•</span>
            <span id="wordCount">0 words</span>
          </div>
        </div>

        <p class="mt-4 text-[12px] opacity-70">Powered by the public <a class="underline" href="https://languagetool.org/" target="_blank" rel="noreferrer">LanguageTool</a> API. Your text is sent to their servers for checking. The free endpoint may rate-limit heavy use.</p>
      </section>

      <!-- Results Card -->
      <aside class="surface rounded-2xl border p-4 lg:p-6 shadow-smooth">
        <div class="flex items-center justify-between mb-4">
          <h2 class="font-semibold">Suggestions</h2>
          <span id="issueBadge" class="text-xs px-2.5 py-1 rounded-full border">0 issues</span>
        </div>

        <!-- Accuracy meter + celebration -->
        <div class="flex items-center gap-4 mb-4">
          <div class="relative w-20 h-20">
            <svg viewBox="0 0 100 100" class="w-20 h-20">
              <circle cx="50" cy="50" r="42" stroke="var(--border)" stroke-width="10" fill="none"/>
              <circle id="accRing" cx="50" cy="50" r="42" stroke="var(--primary)" stroke-width="10" fill="none" stroke-linecap="round" transform="rotate(-90 50 50)"/>
            </svg>
            <div class="absolute inset-0 grid place-content-center text-sm font-semibold"><span id="accLabel">0%</span></div>
          </div>
          <div>
            <p id="accText" class="text-sm opacity-80">Accuracy updates after each check.</p>
            <p id="celebrate" class="text-base font-semibold hidden">🎉 Great job! 100% accuracy!</p>
          </div>
        </div>

        <div id="issuesEmpty" class="text-sm opacity-70">
          Run a check to see grammar, spelling, and style suggestions. Click a suggestion to apply it.
        </div>

        <ul id="issuesList" class="space-y-3 hidden"></ul>

        <div class="mt-6">
          <div class="flex items-center justify-between mb-2">
            <h3 class="text-sm font-semibold">Preview</h3>
            <button id="copyBtn" class="text-xs px-3 py-1.5 rounded-lg border surface btn-glow">Copy</button>
          </div>
          <div id="preview" class="min-h-[8rem] rounded-xl border p-4 text-[15px] leading-7 surface"></div>
        </div>
      </aside>
    </main>

    <footer class="max-w-6xl mx-auto px-4 pb-10 text-xs opacity-70">
      <div class="rounded-2xl border p-4 surface">
        <p><strong>Privacy note:</strong> This demo uses <code>api.languagetool.org</code> which is rate-limited. For production, consider self-hosting or a paid plan.</p>
      </div>
    </footer>
  </div>

  <!-- Templates -->
  <template id="issueItemTpl">
    <li class="border rounded-xl p-3 surface">
      <div class="flex items-center justify-between gap-3">
        <div class="min-w-0">
          <p class="text-sm truncate"><span class="font-semibold">{rule}</span> — <span class="opacity-80">"{context}"</span></p>
          <p class="text-xs opacity-70 mt-1">{message}</p>
        </div>
        <div class="flex flex-wrap gap-2 items-center justify-end">
          {replacements}
        </div>
      </div>
    </li>
  </template>

  <template id="replacementBtnTpl">
    <button class="text-xs px-3 py-1.5 rounded-lg border surface btn-glow">{text}</button>
  </template>

  <!-- App Script -->
  <script>
    const input = document.getElementById('inputText');
    const checkBtn = document.getElementById('checkBtn');
    const issuesList = document.getElementById('issuesList');
    const issuesEmpty = document.getElementById('issuesEmpty');
    const issueBadge = document.getElementById('issueBadge');
    const preview = document.getElementById('preview');
    const pasteBtn = document.getElementById('pasteBtn');
    const clearBtn = document.getElementById('clearBtn');
    const langSelect = document.getElementById('language');
    const charCount = document.getElementById('charCount');
    const wordCount = document.getElementById('wordCount');
    const copyBtn = document.getElementById('copyBtn');

    const themeSelect = document.getElementById('themeSelect');
    const accRing = document.getElementById('accRing');
    const accLabel = document.getElementById('accLabel');
    const accText = document.getElementById('accText');
    const celebrate = document.getElementById('celebrate');

    let lastMatches = [];
    let debounceTimer = null;

    /* =====================
       Counters & Debounce
    ===================== */
    function updateCounts() {
      const text = input.value;
      charCount.textContent = `${text.length} characters`;
      const words = text.trim() ? text.trim().split(/\s+/).length : 0;
      wordCount.textContent = `${words} ${words===1?'word':'words'}`;
    }
    function debounceCheck() {
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(runCheck, 900);
    }
    input.addEventListener('input', () => { updateCounts(); debounceCheck(); });
    document.addEventListener('DOMContentLoaded', updateCounts);

    pasteBtn.addEventListener('click', async () => {
      try { const text = await navigator.clipboard.readText(); input.value = text; updateCounts(); runCheck(); }
      catch { alert('Clipboard permissions are required to paste.'); }
    });
    clearBtn.addEventListener('click', () => { input.value=''; updateCounts(); renderPreview([], ''); renderIssues([]); updateAccuracy(); });
    copyBtn.addEventListener('click', async () => {
      try { await navigator.clipboard.writeText(preview.textContent); copyBtn.textContent='Copied!'; setTimeout(()=>copyBtn.textContent='Copy',1500); }
      catch { alert('Copy failed.'); }
    });

    checkBtn.addEventListener('click', () => runCheck());

    /* =====================
       Grammar Check via LanguageTool API
    ===================== */
    async function runCheck() {
      const text = input.value;
      if (!text.trim()) { renderPreview([], ''); renderIssues([]); updateAccuracy(); return; }

      setLoading(true);
      try {
        const body = new URLSearchParams();
        body.set('text', text);
        body.set('language', langSelect.value || 'en-US');
        const res = await fetch('https://api.languagetool.org/v2/check', {
          method: 'POST', headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, body
        });
        if (!res.ok) throw new Error('LanguageTool error: ' + res.status);
        const data = await res.json();
        lastMatches = data.matches || [];
        renderPreview(lastMatches, text);
        renderIssues(lastMatches, text);
        updateAccuracy();
      } catch (err) {
        console.error(err);
        alert('There was a problem checking your text. The free API may be rate-limited.');
      } finally {
        setLoading(false);
      }
    }

    function setLoading(loading) {
      checkBtn.disabled = loading;
      checkBtn.textContent = loading ? 'Checking…' : 'Check Grammar';
    }

    /* =====================
       Suggestions UI & One-by-one apply
    ===================== */
    function renderIssues(matches, text) {
      const count = matches?.length || 0;
      issueBadge.textContent = `${count} ${count === 1 ? 'issue' : 'issues'}`;

      if (!count) {
        issuesList.classList.add('hidden');
        issuesEmpty.classList.remove('hidden');
        issuesEmpty.textContent = text?.trim() ? 'No issues found. Great job!' : 'Run a check to see grammar, spelling, and style suggestions. Click a suggestion to apply it.';
        return;
      }

      issuesList.innerHTML = '';
      issuesList.classList.remove('hidden');
      issuesEmpty.classList.add('hidden');

      const itemTpl = document.getElementById('issueItemTpl').innerHTML;
      const replTpl = document.getElementById('replacementBtnTpl').innerHTML;

      matches.forEach((m, idx) => {
        const context = text.substr(m.offset, m.length);
        const rule = m.rule?.issueType ? m.rule.issueType.toUpperCase() : (m.rule?.id || 'Suggestion');
        const replacementsHTML = (m.replacements || []).slice(0, 5).map(r => replTpl.replace('{text}', escapeHtml(r.value))).join('');
        const liHtml = itemTpl
          .replace('{rule}', escapeHtml(rule))
          .replace('{context}', escapeHtml(context))
          .replace('{message}', escapeHtml(m.message))
          .replace('{replacements}', replacementsHTML || '<span class="text-xs opacity-60">No quick fix — edit manually</span>');

        const li = htmlToElement(liHtml);
        let buttons = li.querySelectorAll('button');
        buttons.forEach(btn => btn.addEventListener('click', () => applyReplacement(idx, btn.textContent)));
        issuesList.appendChild(li);
      });
    }

    function renderPreview(matches, text) {
      if (!text) text = input.value;
      if (!matches || !matches.length) { preview.textContent = text; return; }

      const segments = []; let cursor = 0;
      matches.sort((a,b)=> a.offset - b.offset).forEach(m => {
        const start = m.offset; const end = m.offset + m.length;
        if (start > cursor) segments.push({ type: 'text', value: text.slice(cursor, start) });
        segments.push({ type: 'issue', value: text.slice(start, end), message: m.message, rule: m.rule?.id, typeLabel: m.rule?.issueType });
        cursor = end;
      });
      if (cursor < text.length) segments.push({ type: 'text', value: text.slice(cursor) });

      preview.innerHTML = '';
      segments.forEach(seg => {
        if (seg.type === 'text') preview.appendChild(document.createTextNode(seg.value));
        else {
          const span = document.createElement('span');
          span.className = 'issue-underline';
          span.style.textDecorationColor = 'var(--accent)';
          span.title = `${seg.typeLabel || 'Issue'}: ${seg.message}`;
          span.textContent = seg.value;
          preview.appendChild(span);
        }
      });
    }

    function applyReplacement(matchIndex, replacement) {
      const m = lastMatches[matchIndex];
      if (!m) return;
      const text = input.value;
      // If text length changed since last check, offsets may be stale. We'll attempt a safe replace using stored offset.
      try {
        const before = text.slice(0, m.offset);
        const after = text.slice(m.offset + m.length);
        input.value = before + replacement + after;
      } catch {
        // Fallback: try to replace the first occurrence of the matched context.
        const context = text.substr(m.offset, m.length);
        input.value = text.replace(context, replacement);
      }
      updateCounts();
      runCheck(); // re-check to refresh offsets & UI
      // Scroll the editor into view to show the change
      input.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function htmlToElement(html) {
      const template = document.createElement('template');
      template.innerHTML = html.trim();
      return template.content.firstChild;
    }

    function escapeHtml(str='') {
      return str.replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#039;');
    }

    /* =====================
       Accuracy Meter (circular)
       Definition: 100% if 0 issues and >=1 word. Otherwise 100 * (1 - issues/words) clamped 0..99.
    ===================== */
    function updateAccuracy() {
      const words = input.value.trim() ? input.value.trim().split(/\s+/).length : 0;
      const issues = lastMatches.length || 0;
      let pct = 0;
      if (words === 0) pct = 0; else if (issues === 0) pct = 100; else pct = Math.max(0, Math.min(99, Math.round(100 * (1 - issues / Math.max(words,1)))));

      // Update ring
      const r = 42; // SVG circle radius
      const C = 2 * Math.PI * r;
      accRing.setAttribute('stroke-dasharray', String(C));
      accRing.setAttribute('stroke-dashoffset', String(C * (1 - pct / 100)));

      accLabel.textContent = `${pct}%`;

      // Update helper text & celebration
      if (pct === 100 && words > 0) {
        celebrate.classList.remove('hidden');
        accText.textContent = 'Awesome work — nothing to fix!';
      } else {
        celebrate.classList.add('hidden');
        accText.textContent = issues === 0 ? 'Type or paste text to get started.' : `${issues} ${issues===1?'issue':'issues'} found across ${words} ${words===1?'word':'words'}.`;
      }
    }

    /* =====================
       Theme handling + persistence
    ===================== */
    function setTheme(theme) {
      document.documentElement.setAttribute('data-theme', theme);
      localStorage.setItem('theme', theme);
      document.body.classList.add('theme-transition');
      setTimeout(()=>document.body.classList.remove('theme-transition'), 400);
    }
    const savedTheme = localStorage.getItem('theme') || (window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light');
    setTheme(savedTheme);
    themeSelect.value = savedTheme;
    themeSelect.addEventListener('change', e => setTheme(e.target.value));
  </script>
</body>
</html>
